import torch
import requests
import hashlib
import random
import json
import re
from urllib.parse import quote
import nodes
import folder_paths
import comfy.utils
from server import PromptServer

# ==================== å·¥å…·å‡½æ•° ====================
def translate_language_name(lang_name):
    """ç¿»è¯‘è¯­è¨€åç§°æ˜ å°„åˆ°ç™¾åº¦APIä»£ç """
    lang_map = {
        "è‡ªåŠ¨æ£€æµ‹": "auto",
        "ä¸­æ–‡": "zh", "ç®€ä½“ä¸­æ–‡": "zh", "ç¹ä½“ä¸­æ–‡": "zh",
        "è‹±è¯­": "en", "è‹±æ–‡": "en",
        "æ—¥è¯­": "jp", "æ—¥æ–‡": "jp",
        "éŸ©è¯­": "kor", "éŸ©æ–‡": "kor",
        "æ³•è¯­": "fra", "æ³•æ–‡": "fra",
        "è¥¿ç­ç‰™è¯­": "spa", "è¥¿ç­ç‰™æ–‡": "spa",
        "ä¿„è¯­": "ru", "ä¿„æ–‡": "ru",
        "å¾·è¯­": "de", "å¾·æ–‡": "de",
        "æ„å¤§åˆ©è¯­": "it", "æ„å¤§åˆ©æ–‡": "it",
        "è‘¡è„ç‰™è¯­": "pt", "è‘¡è„ç‰™æ–‡": "pt",
        "è·å…°è¯­": "nl", "è·å…°æ–‡": "nl",
        "ç‘å…¸è¯­": "sv", "ç‘å…¸æ–‡": "sv",
        "èŠ¬å…°è¯­": "fi", "èŠ¬å…°æ–‡": "fi",
        "ä¸¹éº¦è¯­": "da", "ä¸¹éº¦æ–‡": "da"
    }
    return lang_map.get(lang_name, "auto")

# ==================== æ–‡æœ¬é¢„å¤„ç†å·¥å…·èŠ‚ç‚¹ ====================
class TextPreprocessorNode:
    """
    æ–‡æœ¬é¢„å¤„ç†å·¥å…· - æ¸…æ´—å’Œæ ¼å¼åŒ–æ–‡æœ¬
    åŠŸèƒ½ï¼šå»é™¤å¤šä½™ç©ºæ ¼ã€æ ‡ç‚¹å¤„ç†ã€å¤§å°å†™è½¬æ¢ã€æ–‡æœ¬ä¼˜åŒ–
    """
    
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "è¾“å…¥æ–‡æœ¬": ("STRING", {
                    "multiline": True,
                    "default": "",
                    "placeholder": "è¯·è¾“å…¥éœ€è¦é¢„å¤„ç†çš„æ–‡æœ¬"
                }),
                "é¢„å¤„ç†æ¨¡å¼": (["æ¸…æ´—ç©ºæ ¼", "ç»Ÿä¸€å¤§å°å†™", "å»é™¤æ ‡ç‚¹", "å»é™¤æ•°å­—", "å»é™¤æ¢è¡Œ", "å…¨éƒ¨å¤„ç†"], {
                    "default": "å…¨éƒ¨å¤„ç†",
                    "tooltip": "é€‰æ‹©æ–‡æœ¬é¢„å¤„ç†çš„æ–¹å¼"
                }),
                "å¤§å°å†™è½¬æ¢": (["ä¿æŒåŸæ ·", "å…¨å¤§å†™", "å…¨å°å†™", "é¦–å­—æ¯å¤§å†™", "å¥å­æ¨¡å¼"], {
                    "default": "ä¿æŒåŸæ ·",
                    "tooltip": "é€‰æ‹©å¤§å°å†™è½¬æ¢æ–¹å¼"
                }),
            },
            "optional": {
                "æœ€å¤§é•¿åº¦": ("INT", {
                    "default": 1000,
                    "min": 1,
                    "max": 10000,
                    "step": 10,
                    "tooltip": "é™åˆ¶å¤„ç†åçš„æ–‡æœ¬æœ€å¤§é•¿åº¦"
                }),
                "æ˜¯å¦æ˜¾ç¤ºç»Ÿè®¡": (["æ˜¯", "å¦"], {
                    "default": "æ˜¯",
                    "tooltip": "æ˜¯å¦åœ¨å¤„ç†åæ˜¾ç¤ºæ–‡æœ¬ç»Ÿè®¡ä¿¡æ¯"
                }),
            }
        }
    
    RETURN_TYPES = ("STRING", "STRING")
    RETURN_NAMES = ("å¤„ç†åæ–‡æœ¬", "å¤„ç†ç»Ÿè®¡")
    FUNCTION = "é¢„å¤„ç†æ–‡æœ¬"
    CATEGORY = "å—å…‰AIGC"
    OUTPUT_NODE = True
    
    def é¢„å¤„ç†æ–‡æœ¬(self, è¾“å…¥æ–‡æœ¬, é¢„å¤„ç†æ¨¡å¼, å¤§å°å†™è½¬æ¢, æœ€å¤§é•¿åº¦=1000, æ˜¯å¦æ˜¾ç¤ºç»Ÿè®¡="æ˜¯"):
        """
        æ‰§è¡Œæ–‡æœ¬é¢„å¤„ç†
        """
        if not è¾“å…¥æ–‡æœ¬:
            return ("", "è¾“å…¥æ–‡æœ¬ä¸ºç©º")
        
        å¤„ç†ç»“æœ = è¾“å…¥æ–‡æœ¬
        å¤„ç†æ­¥éª¤ = []
        åŸå§‹é•¿åº¦ = len(è¾“å…¥æ–‡æœ¬)
        
        # æ ¹æ®é¢„å¤„ç†æ¨¡å¼å¤„ç†
        if é¢„å¤„ç†æ¨¡å¼ in ["æ¸…æ´—ç©ºæ ¼", "å…¨éƒ¨å¤„ç†"]:
            # å»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œï¼Œä¿ç•™å•ä¸ªç©ºæ ¼
            å¤„ç†ç»“æœ = re.sub(r'\s+', ' ', å¤„ç†ç»“æœ.strip())
            å¤„ç†æ­¥éª¤.append("æ¸…æ´—ç©ºæ ¼")
        
        if é¢„å¤„ç†æ¨¡å¼ in ["å»é™¤æ ‡ç‚¹", "å…¨éƒ¨å¤„ç†"]:
            # å»é™¤ç‰¹æ®Šæ ‡ç‚¹ï¼ˆä¿ç•™åŸºæœ¬æ ‡ç‚¹ï¼‰
            å¤„ç†ç»“æœ = re.sub(r'[^\w\s,.?!ï¼Œã€‚ï¼Ÿï¼\-:]', '', å¤„ç†ç»“æœ)
            å¤„ç†æ­¥éª¤.append("å»é™¤æ ‡ç‚¹")
        
        if é¢„å¤„ç†æ¨¡å¼ in ["å»é™¤æ•°å­—", "å…¨éƒ¨å¤„ç†"]:
            # å»é™¤æ•°å­—
            å¤„ç†ç»“æœ = re.sub(r'\d+', '', å¤„ç†ç»“æœ)
            å¤„ç†æ­¥éª¤.append("å»é™¤æ•°å­—")
        
        if é¢„å¤„ç†æ¨¡å¼ in ["å»é™¤æ¢è¡Œ", "å…¨éƒ¨å¤„ç†"]:
            # å°†å¤šä¸ªæ¢è¡Œåˆå¹¶ä¸ºä¸€ä¸ª
            å¤„ç†ç»“æœ = re.sub(r'\n+', '\n', å¤„ç†ç»“æœ)
            å¤„ç†æ­¥éª¤.append("å»é™¤æ¢è¡Œ")
        
        # å¤§å°å†™è½¬æ¢
        if å¤§å°å†™è½¬æ¢ == "å…¨å¤§å†™":
            å¤„ç†ç»“æœ = å¤„ç†ç»“æœ.upper()
            å¤„ç†æ­¥éª¤.append("å…¨å¤§å†™")
        elif å¤§å°å†™è½¬æ¢ == "å…¨å°å†™":
            å¤„ç†ç»“æœ = å¤„ç†ç»“æœ.lower()
            å¤„ç†æ­¥éª¤.append("å…¨å°å†™")
        elif å¤§å°å†™è½¬æ¢ == "é¦–å­—æ¯å¤§å†™":
            å¤„ç†ç»“æœ = å¤„ç†ç»“æœ.title()
            å¤„ç†æ­¥éª¤.append("é¦–å­—æ¯å¤§å†™")
        elif å¤§å°å†™è½¬æ¢ == "å¥å­æ¨¡å¼":
            # ç®€å•çš„å¥å­æ¨¡å¼ï¼šæ¯ä¸ªå¥å­é¦–å­—æ¯å¤§å†™
            å¤„ç†ç»“æœ = '. '.join(sentence.strip().capitalize() for sentence in å¤„ç†ç»“æœ.split('. '))
            å¤„ç†ç»“æœ = '! '.join(sentence.strip().capitalize() for sentence in å¤„ç†ç»“æœ.split('! '))
            å¤„ç†ç»“æœ = '? '.join(sentence.strip().capitalize() for sentence in å¤„ç†ç»“æœ.split('? '))
            å¤„ç†æ­¥éª¤.append("å¥å­æ¨¡å¼")
        
        # é™åˆ¶æœ€å¤§é•¿åº¦
        if len(å¤„ç†ç»“æœ) > æœ€å¤§é•¿åº¦:
            å¤„ç†ç»“æœ = å¤„ç†ç»“æœ[:æœ€å¤§é•¿åº¦] + "...[å·²æˆªæ–­]"
            å¤„ç†æ­¥éª¤.append(f"æˆªæ–­åˆ°{æœ€å¤§é•¿åº¦}å­—ç¬¦")
        
        # ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
        å¤„ç†åé•¿åº¦ = len(å¤„ç†ç»“æœ)
        å¤„ç†ç»Ÿè®¡ = ""
        
        if æ˜¯å¦æ˜¾ç¤ºç»Ÿè®¡ == "æ˜¯":
            å¤„ç†ç»Ÿè®¡ = (
                f"ğŸ“Š æ–‡æœ¬å¤„ç†ç»Ÿè®¡:\n"
                f"â€¢ åŸå§‹é•¿åº¦: {åŸå§‹é•¿åº¦} å­—ç¬¦\n"
                f"â€¢ å¤„ç†åé•¿åº¦: {å¤„ç†åé•¿åº¦} å­—ç¬¦\n"
                f"â€¢ å¤„ç†æ­¥éª¤: {', '.join(å¤„ç†æ­¥éª¤)}\n"
                f"â€¢ ç¼©å‡æ¯”ä¾‹: {((åŸå§‹é•¿åº¦ - å¤„ç†åé•¿åº¦) / max(åŸå§‹é•¿åº¦, 1)) * 100:.1f}%"
            )
            
            print(f"âœ… æ–‡æœ¬é¢„å¤„ç†å®Œæˆ")
            print(f"  åŸå§‹é•¿åº¦: {åŸå§‹é•¿åº¦} â†’ å¤„ç†åé•¿åº¦: {å¤„ç†åé•¿åº¦}")
            print(f"  å¤„ç†æ­¥éª¤: {', '.join(å¤„ç†æ­¥éª¤)}")
        else:
            å¤„ç†ç»Ÿè®¡ = f"æ–‡æœ¬é¢„å¤„ç†å®Œæˆ ({å¤„ç†åé•¿åº¦} å­—ç¬¦)"
            print(f"âœ… æ–‡æœ¬é¢„å¤„ç†å®Œæˆ: {å¤„ç†åé•¿åº¦} å­—ç¬¦")
        
        return (å¤„ç†ç»“æœ, å¤„ç†ç»Ÿè®¡)
    
    @classmethod
    def IS_CHANGED(cls, **kwargs):
        # å½“è¾“å…¥æ”¹å˜æ—¶ï¼Œé‡æ–°æ‰§è¡ŒèŠ‚ç‚¹
        return float("nan")

# ==================== ç™¾åº¦ç¿»è¯‘å°åŠ©æ‰‹èŠ‚ç‚¹ ====================
class BaiduTranslatorNode:
    """
    ç™¾åº¦ç¿»è¯‘å°åŠ©æ‰‹ - é›†æˆç™¾åº¦ç¿»è¯‘API
    åŠŸèƒ½ï¼šå¤šè¯­è¨€ç¿»è¯‘ã€æ‰¹é‡ç¿»è¯‘ã€ä¸“ä¸šæœ¯è¯­ç¿»è¯‘
    """
    
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "å¾…ç¿»è¯‘æ–‡æœ¬": ("STRING", {
                    "multiline": True,
                    "default": "è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬",
                    "placeholder": "æ”¯æŒä¸­è‹±æ—¥éŸ©æ³•å¾·æ„ä¿„è¥¿ç­‰å¤šç§è¯­è¨€ç¿»è¯‘"
                }),
                "ç¿»è¯‘å¼€å…³": (["å¼€å¯", "å…³é—­"], {
                    "default": "å¼€å¯",
                    "tooltip": "å¼€å¯æˆ–å…³é—­ç¿»è¯‘åŠŸèƒ½"
                }),
                "æºè¯­è¨€é€‰æ‹©": ([
                    "è‡ªåŠ¨æ£€æµ‹", "ä¸­æ–‡", "è‹±è¯­", "æ—¥è¯­", "éŸ©è¯­", 
                    "æ³•è¯­", "è¥¿ç­ç‰™è¯­", "ä¿„è¯­", "å¾·è¯­", "æ„å¤§åˆ©è¯­",
                    "è‘¡è„ç‰™è¯­", "è·å…°è¯­", "ç‘å…¸è¯­", "èŠ¬å…°è¯­", "ä¸¹éº¦è¯­"
                ], {
                    "default": "è‡ªåŠ¨æ£€æµ‹",
                    "tooltip": "é€‰æ‹©æºè¯­è¨€ç±»å‹"
                }),
                "ç›®æ ‡è¯­è¨€é€‰æ‹©": ([
                    "ä¸­æ–‡", "è‹±è¯­", "æ—¥è¯­", "éŸ©è¯­", 
                    "æ³•è¯­", "è¥¿ç­ç‰™è¯­", "ä¿„è¯­", "å¾·è¯­", "æ„å¤§åˆ©è¯­",
                    "è‘¡è„ç‰™è¯­", "è·å…°è¯­", "ç‘å…¸è¯­", "èŠ¬å…°è¯­", "ä¸¹éº¦è¯­"
                ], {
                    "default": "è‹±è¯­",
                    "tooltip": "é€‰æ‹©ç›®æ ‡è¯­è¨€ç±»å‹"
                }),
                "ç™¾åº¦ç¿»è¯‘APP_ID": ("STRING", {
                    "default": "",
                    "placeholder": "è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘APP ID",
                    "tooltip": "ä»ç™¾åº¦ç¿»è¯‘å¼€æ”¾å¹³å°è·å–çš„APP ID"
                }),
                "ç™¾åº¦ç¿»è¯‘å¯†é’¥": ("STRING", {
                    "default": "",
                    "placeholder": "è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘APIå¯†é’¥",
                    "password": True,
                    "tooltip": "ä»ç™¾åº¦ç¿»è¯‘å¼€æ”¾å¹³å°è·å–çš„å¯†é’¥"
                }),
            },
            "optional": {
                "ç¿»è¯‘æ¨¡å¼": (["å¸¸è§„ç¿»è¯‘", "æ‰¹é‡ç¿»è¯‘", "ä¸“ä¸šæœ¯è¯­", "æ–‡å­¦ç¿»è¯‘"], {
                    "default": "å¸¸è§„ç¿»è¯‘",
                    "tooltip": "é€‰æ‹©ç¿»è¯‘æ¨¡å¼"
                }),
                "ç¿»è¯‘é€Ÿåº¦": (["å¿«é€Ÿ", "æ ‡å‡†", "é«˜è´¨é‡"], {
                    "default": "æ ‡å‡†",
                    "tooltip": "é€‰æ‹©ç¿»è¯‘é€Ÿåº¦å’Œè´¨é‡å¹³è¡¡"
                }),
                "æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ…": (["æ˜¯", "å¦"], {
                    "default": "æ˜¯",
                    "tooltip": "æ˜¯å¦æ˜¾ç¤ºç¿»è¯‘è¯¦æƒ…ä¿¡æ¯"
                }),
                "æœ€å¤§é‡è¯•æ¬¡æ•°": ("INT", {
                    "default": 3,
                    "min": 1,
                    "max": 5,
                    "step": 1,
                    "tooltip": "ç½‘ç»œé”™è¯¯æ—¶æœ€å¤§é‡è¯•æ¬¡æ•°"
                }),
            }
        }
    
    RETURN_TYPES = ("STRING", "STRING", "STRING")
    RETURN_NAMES = ("ç¿»è¯‘ç»“æœ", "ç¿»è¯‘ç»Ÿè®¡", "APIçŠ¶æ€")
    FUNCTION = "æ‰§è¡Œç¿»è¯‘"
    CATEGORY = "å—å…‰AIGC"
    OUTPUT_NODE = True
    
    def æ‰§è¡Œç¿»è¯‘(self, å¾…ç¿»è¯‘æ–‡æœ¬, ç¿»è¯‘å¼€å…³, æºè¯­è¨€é€‰æ‹©, ç›®æ ‡è¯­è¨€é€‰æ‹©, 
                 ç™¾åº¦ç¿»è¯‘APP_ID, ç™¾åº¦ç¿»è¯‘å¯†é’¥, ç¿»è¯‘æ¨¡å¼="å¸¸è§„ç¿»è¯‘", 
                 ç¿»è¯‘é€Ÿåº¦="æ ‡å‡†", æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ…="æ˜¯", æœ€å¤§é‡è¯•æ¬¡æ•°=3):
        """
        æ‰§è¡Œç¿»è¯‘æ“ä½œ
        """
        
        # åˆå§‹åŒ–è¿”å›å˜é‡
        ç¿»è¯‘ç»“æœ = ""
        ç¿»è¯‘ç»Ÿè®¡ = ""
        APIçŠ¶æ€ = ""
        
        # 1. æ£€æŸ¥ç¿»è¯‘å¼€å…³
        if ç¿»è¯‘å¼€å…³ == "å…³é—­":
            APIçŠ¶æ€ = "âš ï¸ ç¿»è¯‘åŠŸèƒ½å·²å…³é—­"
            ç¿»è¯‘ç»Ÿè®¡ = "ç¿»è¯‘æœªæ‰§è¡Œ"
            if æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ… == "æ˜¯":
                print(APIçŠ¶æ€)
            return (å¾…ç¿»è¯‘æ–‡æœ¬, ç¿»è¯‘ç»Ÿè®¡, APIçŠ¶æ€)
        
        # 2. æ£€æŸ¥è¾“å…¥æ–‡æœ¬
        if not å¾…ç¿»è¯‘æ–‡æœ¬ or å¾…ç¿»è¯‘æ–‡æœ¬.strip() == "":
            APIçŠ¶æ€ = "âš ï¸ è¾“å…¥æ–‡æœ¬ä¸ºç©º"
            ç¿»è¯‘ç»Ÿè®¡ = "æ— æ–‡æœ¬éœ€è¦ç¿»è¯‘"
            if æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ… == "æ˜¯":
                print(APIçŠ¶æ€)
            return ("", ç¿»è¯‘ç»Ÿè®¡, APIçŠ¶æ€)
        
        # 3. æ£€æŸ¥APIä¿¡æ¯
        if not ç™¾åº¦ç¿»è¯‘APP_ID or not ç™¾åº¦ç¿»è¯‘å¯†é’¥:
            APIçŠ¶æ€ = "âŒ é”™è¯¯ï¼šè¯·æä¾›ç™¾åº¦ç¿»è¯‘APP IDå’ŒAPIå¯†é’¥"
            ç¿»è¯‘ç»Ÿè®¡ = "APIé…ç½®ä¸å®Œæ•´"
            if æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ… == "æ˜¯":
                print(APIçŠ¶æ€)
            return (å¾…ç¿»è¯‘æ–‡æœ¬, ç¿»è¯‘ç»Ÿè®¡, APIçŠ¶æ€)
        
        # 4. éªŒè¯APIä¿¡æ¯æ ¼å¼
        if len(ç™¾åº¦ç¿»è¯‘APP_ID) < 8 or len(ç™¾åº¦ç¿»è¯‘å¯†é’¥) < 8:
            APIçŠ¶æ€ = "âŒ é”™è¯¯ï¼šAPP IDæˆ–å¯†é’¥æ ¼å¼ä¸æ­£ç¡®"
            ç¿»è¯‘ç»Ÿè®¡ = "APIæ ¼å¼é”™è¯¯"
            if æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ… == "æ˜¯":
                print(APIçŠ¶æ€)
            return (å¾…ç¿»è¯‘æ–‡æœ¬, ç¿»è¯‘ç»Ÿè®¡, APIçŠ¶æ€)
        
        # 5. è·å–è¯­è¨€ä»£ç 
        æºè¯­è¨€ä»£ç  = translate_language_name(æºè¯­è¨€é€‰æ‹©)
        ç›®æ ‡è¯­è¨€ä»£ç  = translate_language_name(ç›®æ ‡è¯­è¨€é€‰æ‹©)
        
        # è®°å½•å¼€å§‹ä¿¡æ¯
        åŸæ–‡é•¿åº¦ = len(å¾…ç¿»è¯‘æ–‡æœ¬)
        if æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ… == "æ˜¯":
            print(f"ğŸ”§ å¼€å§‹ç¿»è¯‘ï¼š{æºè¯­è¨€é€‰æ‹©} â†’ {ç›®æ ‡è¯­è¨€é€‰æ‹©}")
            print(f"ğŸ“ åŸæ–‡é•¿åº¦ï¼š{åŸæ–‡é•¿åº¦} å­—ç¬¦")
            print(f"âš™ï¸  ç¿»è¯‘æ¨¡å¼ï¼š{ç¿»è¯‘æ¨¡å¼}")
            print(f"ğŸš€ ç¿»è¯‘é€Ÿåº¦ï¼š{ç¿»è¯‘é€Ÿåº¦}")
        
        try:
            # 6. æ ¹æ®ç¿»è¯‘æ¨¡å¼è°ƒç”¨ä¸åŒæ–¹æ³•
            if ç¿»è¯‘æ¨¡å¼ == "æ‰¹é‡ç¿»è¯‘":
                ç¿»è¯‘ç»“æœ, APIçŠ¶æ€ = self._æ‰¹é‡ç¿»è¯‘(
                    å¾…ç¿»è¯‘æ–‡æœ¬, æºè¯­è¨€ä»£ç , ç›®æ ‡è¯­è¨€ä»£ç , 
                    ç™¾åº¦ç¿»è¯‘APP_ID, ç™¾åº¦ç¿»è¯‘å¯†é’¥, æœ€å¤§é‡è¯•æ¬¡æ•°
                )
            elif ç¿»è¯‘æ¨¡å¼ == "ä¸“ä¸šæœ¯è¯­":
                ç¿»è¯‘ç»“æœ, APIçŠ¶æ€ = self._ä¸“ä¸šæœ¯è¯­ç¿»è¯‘(
                    å¾…ç¿»è¯‘æ–‡æœ¬, æºè¯­è¨€ä»£ç , ç›®æ ‡è¯­è¨€ä»£ç , 
                    ç™¾åº¦ç¿»è¯‘APP_ID, ç™¾åº¦ç¿»è¯‘å¯†é’¥, æœ€å¤§é‡è¯•æ¬¡æ•°
                )
            elif ç¿»è¯‘æ¨¡å¼ == "æ–‡å­¦ç¿»è¯‘":
                ç¿»è¯‘ç»“æœ, APIçŠ¶æ€ = self._æ–‡å­¦ç¿»è¯‘(
                    å¾…ç¿»è¯‘æ–‡æœ¬, æºè¯­è¨€ä»£ç , ç›®æ ‡è¯­è¨€ä»£ç , 
                    ç™¾åº¦ç¿»è¯‘APP_ID, ç™¾åº¦ç¿»è¯‘å¯†é’¥, æœ€å¤§é‡è¯•æ¬¡æ•°
                )
            else:
                # å¸¸è§„ç¿»è¯‘
                ç¿»è¯‘ç»“æœ, APIçŠ¶æ€ = self._ç™¾åº¦ç¿»è¯‘API(
                    å¾…ç¿»è¯‘æ–‡æœ¬, æºè¯­è¨€ä»£ç , ç›®æ ‡è¯­è¨€ä»£ç , 
                    ç™¾åº¦ç¿»è¯‘APP_ID, ç™¾åº¦ç¿»è¯‘å¯†é’¥, æœ€å¤§é‡è¯•æ¬¡æ•°
                )
            
            # 7. ç”Ÿæˆç¿»è¯‘ç»Ÿè®¡
            ç¿»è¯‘åé•¿åº¦ = len(ç¿»è¯‘ç»“æœ)
            å­—ç¬¦å˜åŒ– = ç¿»è¯‘åé•¿åº¦ - åŸæ–‡é•¿åº¦
            å˜åŒ–æ¯”ä¾‹ = (å­—ç¬¦å˜åŒ– / max(åŸæ–‡é•¿åº¦, 1)) * 100
            
            ç¿»è¯‘ç»Ÿè®¡ = (
                f"ğŸ“Š ç¿»è¯‘ç»Ÿè®¡:\n"
                f"â€¢ åŸæ–‡é•¿åº¦: {åŸæ–‡é•¿åº¦} å­—ç¬¦\n"
                f"â€¢ è¯‘æ–‡é•¿åº¦: {ç¿»è¯‘åé•¿åº¦} å­—ç¬¦\n"
                f"â€¢ å­—ç¬¦å˜åŒ–: {å­—ç¬¦å˜åŒ–:+#d} ({å˜åŒ–æ¯”ä¾‹:+.1f}%)\n"
                f"â€¢ ç¿»è¯‘æ¨¡å¼: {ç¿»è¯‘æ¨¡å¼}\n"
                f"â€¢ è¯­è¨€æ–¹å‘: {æºè¯­è¨€é€‰æ‹©} â†’ {ç›®æ ‡è¯­è¨€é€‰æ‹©}"
            )
            
            # 8. è®°å½•æˆåŠŸä¿¡æ¯
            if æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ… == "æ˜¯":
                print(f"âœ… ç¿»è¯‘å®Œæˆ")
                print(f"  åŸæ–‡é•¿åº¦: {åŸæ–‡é•¿åº¦} â†’ è¯‘æ–‡é•¿åº¦: {ç¿»è¯‘åé•¿åº¦}")
                print(f"  å­—ç¬¦å˜åŒ–: {å­—ç¬¦å˜åŒ–:+#d} ({å˜åŒ–æ¯”ä¾‹:+.1f}%)")
                
                # æ˜¾ç¤ºéƒ¨åˆ†ç¿»è¯‘ç»“æœé¢„è§ˆ
                if ç¿»è¯‘ç»“æœ:
                    é¢„è§ˆæ–‡æœ¬ = ç¿»è¯‘ç»“æœ[:100] + "..." if len(ç¿»è¯‘ç»“æœ) > 100 else ç¿»è¯‘ç»“æœ
                    print(f"  ç¿»è¯‘é¢„è§ˆ: {é¢„è§ˆæ–‡æœ¬}")
            
            return (ç¿»è¯‘ç»“æœ, ç¿»è¯‘ç»Ÿè®¡, APIçŠ¶æ€)
            
        except Exception as e:
            # 9. å¤„ç†ç¿»è¯‘é”™è¯¯
            error_msg = str(e)
            APIçŠ¶æ€ = f"âŒ ç¿»è¯‘å¤±è´¥ï¼š{error_msg}"
            ç¿»è¯‘ç»Ÿè®¡ = f"ç¿»è¯‘é”™è¯¯: {error_msg}"
            
            if æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ… == "æ˜¯":
                print(f"âŒ ç¿»è¯‘é”™è¯¯ï¼š{error_msg}")
                print(f"  åŸæ–‡: {å¾…ç¿»è¯‘æ–‡æœ¬[:50]}..." if len(å¾…ç¿»è¯‘æ–‡æœ¬) > 50 else f"  åŸæ–‡: {å¾…ç¿»è¯‘æ–‡æœ¬}")
            
            return (å¾…ç¿»è¯‘æ–‡æœ¬, ç¿»è¯‘ç»Ÿè®¡, APIçŠ¶æ€)
    
    def _ç™¾åº¦ç¿»è¯‘API(self, text, from_lang, to_lang, app_id, secret_key, max_retries=3):
        """
        è°ƒç”¨ç™¾åº¦ç¿»è¯‘APIï¼ˆæ ‡å‡†ç‰ˆï¼‰
        å‚è€ƒï¼šhttps://api.fanyi.baidu.com/doc/21
        """
        url = "http://api.fanyi.baidu.com/api/trans/vip/translate"
        
        # ç”Ÿæˆéšæœºæ•°
        salt = str(random.randint(10000, 99999))
        
        # è®¡ç®—ç­¾å
        sign_str = app_id + text + salt + secret_key
        sign = hashlib.md5(sign_str.encode()).hexdigest()
        
        # å‡†å¤‡è¯·æ±‚å‚æ•°
        params = {
            "q": text,
            "from": from_lang,
            "to": to_lang,
            "appid": app_id,
            "salt": salt,
            "sign": sign
        }
        
        # é‡è¯•æœºåˆ¶
        for attempt in range(max_retries):
            try:
                # è®¾ç½®è¶…æ—¶æ—¶é—´
                timeout = 15 if attempt == 0 else 30
                
                # å‘é€è¯·æ±‚
                response = requests.get(url, params=params, timeout=timeout)
                response.raise_for_status()
                
                # è§£æå“åº”
                result = response.json()
                
                # æ£€æŸ¥é”™è¯¯
                if "error_code" in result:
                    error_code = result.get("error_code", "")
                    error_msg = result.get("error_msg", "æœªçŸ¥é”™è¯¯")
                    
                    # å¸¸è§é”™è¯¯å¤„ç†
                    error_messages = {
                        "54001": "ç­¾åé”™è¯¯ï¼Œè¯·æ£€æŸ¥APP IDå’Œå¯†é’¥",
                        "52001": "è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•",
                        "54003": "è®¿é—®é¢‘ç‡å—é™ï¼Œè¯·ç¨åå†è¯•",
                        "54004": "è´¦æˆ·ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼",
                        "58001": "ä¸æ”¯æŒçš„è¯­è¨€æ–¹å‘",
                        "58002": "æœåŠ¡å…³é—­ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€"
                    }
                    
                    if error_code in error_messages:
                        raise Exception(f"{error_messages[error_code]} (é”™è¯¯ç : {error_code})")
                    else:
                        raise Exception(f"APIé”™è¯¯ {error_code}: {error_msg}")
                
                # æå–ç¿»è¯‘ç»“æœ
                if "trans_result" in result:
                    translated_texts = []
                    for item in result["trans_result"]:
                        translated_texts.append(item["dst"])
                    
                    api_status = f"âœ… ç¿»è¯‘æˆåŠŸ (å°è¯• {attempt + 1} æ¬¡)"
                    return "\n".join(translated_texts), api_status
                else:
                    raise Exception("APIè¿”å›æ ¼å¼é”™è¯¯")
                    
            except requests.exceptions.Timeout:
                if attempt < max_retries - 1:
                    print(f"âš ï¸ è¯·æ±‚è¶…æ—¶ï¼Œç¬¬ {attempt + 1} æ¬¡é‡è¯•...")
                    continue
                else:
                    raise Exception(f"è¯·æ±‚è¶…æ—¶ï¼Œå·²é‡è¯• {max_retries} æ¬¡")
                    
            except requests.exceptions.ConnectionError:
                if attempt < max_retries - 1:
                    print(f"âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œç¬¬ {attempt + 1} æ¬¡é‡è¯•...")
                    continue
                else:
                    raise Exception("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®")
                    
            except json.JSONDecodeError:
                raise Exception("APIå“åº”è§£æå¤±è´¥")
        
        # æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
        raise Exception(f"ç¿»è¯‘å¤±è´¥ï¼Œå·²é‡è¯• {max_retries} æ¬¡")
    
    def _æ‰¹é‡ç¿»è¯‘(self, text, from_lang, to_lang, app_id, secret_key, max_retries=3):
        """æ‰¹é‡ç¿»è¯‘æ¨¡å¼ - æŒ‰è¡Œåˆ†å‰²ç¿»è¯‘"""
        # æŒ‰è¡Œåˆ†å‰²æ–‡æœ¬
        lines = [line.strip() for line in text.strip().split('\n') if line.strip()]
        
        if not lines:
            return "", "âš ï¸ æ‰¹é‡ç¿»è¯‘ï¼šè¾“å…¥æ–‡æœ¬ä¸ºç©º"
        
        translated_lines = []
        success_count = 0
        fail_count = 0
        
        for i, line in enumerate(lines):
            try:
                translated, _ = self._ç™¾åº¦ç¿»è¯‘API(line, from_lang, to_lang, app_id, secret_key, 1)
                translated_lines.append(translated)
                success_count += 1
                
                if (i + 1) % 5 == 0:  # æ¯5è¡Œæ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
                    print(f"  æ‰¹é‡ç¿»è¯‘è¿›åº¦: {i + 1}/{len(lines)} è¡Œ")
                    
            except Exception as e:
                # æŸè¡Œç¿»è¯‘å¤±è´¥ï¼Œä¿ç•™åŸæ–‡å¹¶æ ‡è®°
                translated_lines.append(f"[ç¿»è¯‘å¤±è´¥] {line}")
                fail_count += 1
                print(f"âš ï¸ ç¬¬ {i + 1} è¡Œç¿»è¯‘å¤±è´¥ï¼š{str(e)}")
        
        result_text = '\n'.join(translated_lines)
        status = f"âœ… æ‰¹é‡ç¿»è¯‘å®Œæˆï¼šæˆåŠŸ {success_count} è¡Œï¼Œå¤±è´¥ {fail_count} è¡Œ"
        
        return result_text, status
    
    def _ä¸“ä¸šæœ¯è¯­ç¿»è¯‘(self, text, from_lang, to_lang, app_id, secret_key, max_retries=3):
        """ä¸“ä¸šæœ¯è¯­ç¿»è¯‘æ¨¡å¼ - é’ˆå¯¹æŠ€æœ¯æ–‡æ¡£ä¼˜åŒ–"""
        # æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ä¸“ä¸šæœ¯è¯­
        æŠ€æœ¯å…³é”®è¯ = [
            "function", "method", "class", "interface", "protocol",
            "algorithm", "framework", "library", "module", "component"
        ]
        
        åŒ…å«æŠ€æœ¯è¯ = any(keyword in text.lower() for keyword in æŠ€æœ¯å…³é”®è¯)
        
        if åŒ…å«æŠ€æœ¯è¯ and from_lang == "en" and to_lang == "zh":
            # å¯¹æŠ€æœ¯æ–‡æ¡£è¿›è¡Œä¼˜åŒ–ç¿»è¯‘
            ä¼˜åŒ–æ–‡æœ¬ = f"è¯·å‡†ç¡®ç¿»è¯‘æŠ€æœ¯æ–‡æ¡£ï¼Œä¿æŒæœ¯è¯­ä¸€è‡´æ€§ï¼š\n{text}"
            result, status = self._ç™¾åº¦ç¿»è¯‘API(ä¼˜åŒ–æ–‡æœ¬, from_lang, to_lang, app_id, secret_key, max_retries)
            
            # ç§»é™¤å¯èƒ½çš„æç¤ºå‰ç¼€
            if result.startswith("è¯·å‡†ç¡®ç¿»è¯‘æŠ€æœ¯æ–‡æ¡£ï¼Œä¿æŒæœ¯è¯­ä¸€è‡´æ€§ï¼š"):
                result = result[len("è¯·å‡†ç¡®ç¿»è¯‘æŠ€æœ¯æ–‡æ¡£ï¼Œä¿æŒæœ¯è¯­ä¸€è‡´æ€§ï¼š"):].lstrip('\n')
            
            status = "âœ… ä¸“ä¸šæœ¯è¯­ç¿»è¯‘å®Œæˆï¼ˆæŠ€æœ¯æ–‡æ¡£ä¼˜åŒ–ï¼‰"
            return result, status
        else:
            # éæŠ€æœ¯æ–‡æ¡£ä½¿ç”¨æ ‡å‡†ç¿»è¯‘
            result, status = self._ç™¾åº¦ç¿»è¯‘API(text, from_lang, to_lang, app_id, secret_key, max_retries)
            status = "âœ… ä¸“ä¸šæœ¯è¯­ç¿»è¯‘å®Œæˆï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰"
            return result, status
    
    def _æ–‡å­¦ç¿»è¯‘(self, text, from_lang, to_lang, app_id, secret_key, max_retries=3):
        """æ–‡å­¦ç¿»è¯‘æ¨¡å¼ - é’ˆå¯¹æ–‡å­¦æ€§æ–‡æœ¬ä¼˜åŒ–"""
        # æ£€æŸ¥æ–‡æœ¬çš„æ–‡å­¦æ€§ï¼ˆç®€å•çš„å¯å‘å¼åˆ¤æ–­ï¼‰
        æ–‡å­¦ç‰¹å¾ = any(char in text for char in ['ã€‚', 'ï¼', 'ï¼Ÿ', 'ï¼›', 'ï¼š'])
        
        if æ–‡å­¦ç‰¹å¾ and from_lang == "zh" and to_lang == "en":
            # å¯¹ä¸­æ–‡æ–‡å­¦æ–‡æœ¬è¿›è¡Œä¼˜åŒ–
            ä¼˜åŒ–æ–‡æœ¬ = f"è¯·ä»¥æ–‡å­¦é£æ ¼ç¿»è¯‘ï¼Œä¿æŒè¯—æ„å’ŒéŸµå¾‹ï¼š\n{text}"
            result, status = self._ç™¾åº¦ç¿»è¯‘API(ä¼˜åŒ–æ–‡æœ¬, from_lang, to_lang, app_id, secret_key, max_retries)
            
            # ç§»é™¤å¯èƒ½çš„æç¤ºå‰ç¼€
            if result.startswith("è¯·ä»¥æ–‡å­¦é£æ ¼ç¿»è¯‘ï¼Œä¿æŒè¯—æ„å’ŒéŸµå¾‹ï¼š"):
                result = result[len("è¯·ä»¥æ–‡å­¦é£æ ¼ç¿»è¯‘ï¼Œä¿æŒè¯—æ„å’ŒéŸµå¾‹ï¼š"):].lstrip('\n')
            
            status = "âœ… æ–‡å­¦ç¿»è¯‘å®Œæˆï¼ˆè¯—æ„é£æ ¼ï¼‰"
            return result, status
        else:
            # éæ–‡å­¦æ–‡æœ¬ä½¿ç”¨æ ‡å‡†ç¿»è¯‘
            result, status = self._ç™¾åº¦ç¿»è¯‘API(text, from_lang, to_lang, app_id, secret_key, max_retries)
            status = "âœ… æ–‡å­¦ç¿»è¯‘å®Œæˆï¼ˆæ ‡å‡†é£æ ¼ï¼‰"
            return result, status
    
    @classmethod
    def IS_CHANGED(cls, **kwargs):
        # å½“è¾“å…¥æ”¹å˜æ—¶ï¼Œé‡æ–°æ‰§è¡ŒèŠ‚ç‚¹
        return float("nan")

# ==================== èŠ‚ç‚¹æ³¨å†Œ ====================
NODE_CLASS_MAPPINGS = {
    "BaiduTranslatorNode": BaiduTranslatorNode,
    "TextPreprocessorNode": TextPreprocessorNode,
}

NODE_DISPLAY_NAME_MAPPINGS = {
    "BaiduTranslatorNode": "ç™¾åº¦ç¿»è¯‘å°åŠ©æ‰‹",
    "TextPreprocessorNode": "æ–‡æœ¬é¢„å¤„ç†å·¥å…·",
}